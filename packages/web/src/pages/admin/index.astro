---
import Base from "../../layouts/Base.astro";
---

<Base title="Admin Dashboard">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>

    <!-- Auth -->
    <div id="auth-form" class="bg-white rounded-lg border border-gray-200 p-6 max-w-md mx-auto">
      <label class="text-sm font-medium text-gray-700 block mb-2">Admin Key</label>
      <input type="password" id="admin-key" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" />
      <button id="btn-login" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
        Login
      </button>
    </div>

    <div id="dashboard" class="hidden space-y-6">
      <!-- Stats -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
          <p class="text-2xl font-bold" id="stat-total">-</p>
          <p class="text-xs text-gray-500">Total Domains</p>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
          <p class="text-2xl font-bold" id="stat-active">-</p>
          <p class="text-xs text-gray-500">Active</p>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
          <p class="text-2xl font-bold" id="stat-dead">-</p>
          <p class="text-xs text-gray-500">Dead</p>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
          <p class="text-2xl font-bold" id="stat-pending">-</p>
          <p class="text-xs text-gray-500">Pending Evidence</p>
        </div>
      </div>

      <!-- Nav -->
      <div class="flex gap-4">
        <a href="/admin/evidence" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-medium hover:bg-yellow-200">
          Review Evidence
        </a>
        <a href="/admin/domains" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg text-sm font-medium hover:bg-blue-200">
          Manage Domains
        </a>
      </div>
    </div>
  </div>

  <script>
    const API = import.meta.env.PUBLIC_API_URL || "https://api.siteage.org";

    document.getElementById("btn-login")?.addEventListener("click", async () => {
      const key = (document.getElementById("admin-key") as HTMLInputElement).value;
      if (!key) return;

      localStorage.setItem("admin_key", key);

      try {
        const resp = await fetch(`${API}/admin/dashboard`, {
          headers: { "X-Admin-Key": key },
        });
        if (!resp.ok) throw new Error("Invalid key");
        const data = await resp.json();

        document.getElementById("auth-form")!.classList.add("hidden");
        document.getElementById("dashboard")!.classList.remove("hidden");
        document.getElementById("stat-total")!.textContent = data.stats?.total_domains ?? "-";
        document.getElementById("stat-active")!.textContent = data.stats?.active_domains ?? "-";
        document.getElementById("stat-dead")!.textContent = data.stats?.dead_domains ?? "-";
        document.getElementById("stat-pending")!.textContent = data.pending_evidence_count ?? "-";
      } catch {
        alert("Invalid admin key");
      }
    });

    // Auto-login if key stored
    const stored = localStorage.getItem("admin_key");
    if (stored) {
      (document.getElementById("admin-key") as HTMLInputElement).value = stored;
      document.getElementById("btn-login")?.click();
    }
  </script>
</Base>
