---
import Base from "../../layouts/Base.astro";
import { API_BASE_URL, isValidDomain } from "@siteage/shared";
import type { ManageData } from "@siteage/shared";

const apiBase = import.meta.env.PUBLIC_API_URL || API_BASE_URL;
const { domain } = Astro.params;
const key = Astro.url.searchParams.get("key");

if (!domain || !isValidDomain(domain) || !key) {
  return Astro.redirect("/");
}

let data: ManageData | null = null;
let error: string | null = null;

try {
  const resp = await fetch(`${apiBase}/manage/${domain}?key=${key}`);
  if (resp.ok) {
    data = await resp.json() as ManageData;
  } else {
    const err = await resp.json().catch(() => null);
    error = (err as any)?.message || "Invalid or expired management link";
  }
} catch {
  error = "Unable to connect to the API";
}

const displayBirthDate = data ? (data.verified_birth_at || data.birth_at || null) : null;
---

<Base title={`Manage ${domain}`}>
  <div class="max-w-2xl mx-auto px-6 py-12 sm:py-20">
    <!-- Page header -->
    <div class="text-center mb-10">
      <span class="text-xs tracking-[0.3em] uppercase text-seal-dark font-medium">Domain Management</span>
      <h1 class="font-display text-2xl sm:text-3xl mt-3 text-ink">{domain}</h1>
      <div class="ornament-line max-w-32 mx-auto mt-4"></div>
    </div>

    {error && (
      <div class="card-base p-6 border-l-3 border-l-ink-muted/40">
        <p class="text-ink-muted font-light">{error}</p>
      </div>
    )}

    {data && (
      <div class="space-y-6">
        <!-- Status -->
        <div class="card-base p-6 sm:p-8">
          <h2 class="card-title">Status</h2>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-ink-muted font-light">Domain:</span>
              <span class="font-medium text-ink ml-2">{data.domain}</span>
            </div>
            <div>
              <span class="text-ink-muted font-light">Status:</span>
              <span class="font-medium text-ink ml-2">{data.status}</span>
            </div>
            <div class="col-span-2">
              <div class="flex items-center gap-2">
                <span class="text-ink-muted font-light">Birth date:</span>
                <!-- Display mode -->
                <span id="birth-display" class="font-medium text-ink">{displayBirthDate || "Unknown"}</span>
                <!-- Edit mode (hidden by default) -->
                <div id="birth-edit" class="hidden items-center gap-2">
                  <input type="datetime-local" id="birth-input" class="input-archival !py-1 !text-sm" />
                  <span class="text-[10px] text-ink-muted/60 tracking-wide">UTC</span>
                  <button id="birth-save" class="btn-primary !py-1 !px-3 !text-xs">Save</button>
                  <button id="birth-cancel" class="text-xs text-ink-muted hover:text-ink transition-colors cursor-pointer">Cancel</button>
                </div>
                <button id="birth-edit-btn" class="text-xs text-azure hover:text-azure/80 transition-colors cursor-pointer ml-1">Edit</button>
              </div>
              <!-- Inline result area -->
              <div id="birth-result" class="mt-2 hidden"></div>
            </div>
            <div>
              <span class="text-ink-muted font-light">Verification:</span>
              <span class="font-medium text-ink ml-2">{data.verification_status}</span>
            </div>
          </div>
        </div>

        <!-- Evidence form (hidden by default, shown when requires_evidence) -->
        <div id="evidence-section" class="hidden">
          <div class="card-base p-6 sm:p-8">
            <h2 class="card-title">Evidence Required</h2>
            <p id="evidence-reason" class="text-sm text-ink-muted font-light mb-5"></p>
            <form id="evidence-form" class="space-y-5">
              <div>
                <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Evidence type</label>
                <select id="ev-type" class="select-archival">
                  <option value="web_archive" selected>Web Archive (archive.org)</option>
                  <option value="product_hunt">Product Hunt</option>
                  <option value="hacker_news">Hacker News</option>
                  <option value="press_coverage">Press Coverage</option>
                  <option value="whois">WHOIS Record</option>
                  <option value="git_history">Git History</option>
                  <option value="dns_record">DNS Record</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Evidence URL (optional)</label>
                <input type="url" id="ev-url" class="input-archival" placeholder="https://..." />
              </div>
              <div>
                <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Description <span class="text-ink-muted/60">(required)</span></label>
                <textarea id="ev-desc" class="input-archival" rows="3" placeholder="Please describe the evidence that supports this earlier date..." required></textarea>
              </div>
              <button type="submit" class="btn-primary">
                Submit Evidence
              </button>
            </form>
            <div id="ev-result" class="mt-4 hidden"></div>
          </div>
        </div>

        <!-- Previous evidence -->
        {data.evidence && data.evidence.length > 0 && (
          <div class="card-base p-6 sm:p-8">
            <h2 class="card-title">Your Evidence Submissions</h2>
            <div class="space-y-3">
              {data.evidence.map((ev) => (
                <div class="text-sm border-b border-divider pb-2">
                  <div class="flex items-center justify-between">
                    <div>
                      <span class="font-medium text-ink">{ev.type}</span>
                      <span class="text-ink-muted/50 ml-2">claimed: {ev.claimed_at}</span>
                    </div>
                    <span class={`px-2 py-0.5 text-xs tracking-[0.1em] uppercase font-medium ${
                      ev.status === "approved" ? "text-seal-dark bg-seal-light/20" :
                      ev.status === "rejected" ? "text-ink-muted bg-parchment-dark" :
                      "text-azure bg-azure/10"
                    }`}>
                      {ev.status}
                    </span>
                  </div>
                  {ev.status === "rejected" && ev.rejection_reason && (
                    <p class="text-xs text-ink-muted mt-1">Reason: {ev.rejection_reason}</p>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </div>

  <script define:vars={{ domain, key, apiBase, displayBirthDate }}>
    const API = apiBase;
    let pendingBirthDate = null;

    // --- Utility ---
    function showResult(el, message, success) {
      el.classList.remove("hidden");
      el.innerHTML = success
        ? `<p class="text-sm text-seal-dark font-medium tracking-wide">${message}</p>`
        : `<p class="text-sm text-ink-muted">${message}</p>`;
    }

    // --- Birth date inline editing ---
    const editBtn = document.getElementById("birth-edit-btn");
    const birthDisplay = document.getElementById("birth-display");
    const birthEdit = document.getElementById("birth-edit");
    const birthInput = document.getElementById("birth-input");
    const birthSave = document.getElementById("birth-save");
    const birthCancel = document.getElementById("birth-cancel");
    const birthResult = document.getElementById("birth-result");

    if (editBtn) {
      // Pre-fill input with current date and time
      if (displayBirthDate) {
        // datetime-local expects "YYYY-MM-DDThh:mm" format
        birthInput.value = displayBirthDate.slice(0, 16);
      }

      editBtn.addEventListener("click", () => {
        birthDisplay.classList.add("hidden");
        editBtn.classList.add("hidden");
        birthEdit.classList.remove("hidden");
        birthEdit.classList.add("flex");
        birthResult.classList.add("hidden");
      });

      birthCancel.addEventListener("click", () => {
        birthEdit.classList.add("hidden");
        birthEdit.classList.remove("flex");
        birthDisplay.classList.remove("hidden");
        editBtn.classList.remove("hidden");
      });

      birthSave.addEventListener("click", async () => {
        const newDate = birthInput.value;
        if (!newDate) return;

        birthSave.disabled = true;
        birthSave.textContent = "Saving...";

        try {
          const resp = await fetch(`${API}/manage/${domain}/birth-date`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key, birth_at: newDate.length === 16 ? newDate + ":00Z" : newDate + "Z" }),
          });
          const result = await resp.json();

          if (result.outcome === "auto_approved") {
            // Success â€” show message and refresh
            birthEdit.classList.add("hidden");
            birthEdit.classList.remove("flex");
            birthDisplay.textContent = result.birth_at.slice(0, 10);
            birthDisplay.classList.remove("hidden");
            editBtn.classList.remove("hidden");
            showResult(birthResult, "Birth date updated successfully.", true);
            setTimeout(() => location.reload(), 1500);
          } else if (result.outcome === "requires_evidence") {
            // Show evidence form with reason
            pendingBirthDate = newDate.length === 16 ? newDate + ":00Z" : newDate + "Z";
            birthEdit.classList.add("hidden");
            birthEdit.classList.remove("flex");
            birthDisplay.classList.remove("hidden");
            editBtn.classList.remove("hidden");
            showResult(birthResult, "This change requires evidence. Please fill out the form below.", false);

            const evidenceSection = document.getElementById("evidence-section");
            const evidenceReason = document.getElementById("evidence-reason");
            evidenceReason.textContent = result.reason;
            evidenceSection.classList.remove("hidden");
            evidenceSection.scrollIntoView({ behavior: "smooth", block: "center" });
          } else if (result.outcome === "rejected") {
            showResult(birthResult, result.message, false);
          } else {
            showResult(birthResult, result.message || "Update failed", false);
          }
        } catch {
          showResult(birthResult, "Failed to connect to the API", false);
        } finally {
          birthSave.disabled = false;
          birthSave.textContent = "Save";
        }
      });
    }

    // --- Evidence form ---
    document.getElementById("evidence-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const description = document.getElementById("ev-desc").value.trim();
      if (!description) {
        showResult(document.getElementById("ev-result"), "Description is required.", false);
        return;
      }

      const type = document.getElementById("ev-type").value;
      const url = document.getElementById("ev-url").value;
      const claimedAt = pendingBirthDate;

      if (!claimedAt) {
        showResult(document.getElementById("ev-result"), "No pending birth date. Please edit the birth date first.", false);
        return;
      }

      try {
        const resp = await fetch(`${API}/evidence/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            domain,
            key,
            type,
            claimed_at: claimedAt,
            url: url || undefined,
            description,
          }),
        });
        const data = await resp.json();
        const resultEl = document.getElementById("ev-result");
        if (resp.ok) {
          showResult(resultEl, "Evidence submitted successfully! An admin will review it.", true);
          pendingBirthDate = null;
        } else {
          showResult(resultEl, data.message || "Submission failed", false);
        }
      } catch {
        showResult(document.getElementById("ev-result"), "Failed to submit evidence", false);
      }
    });
  </script>
</Base>
