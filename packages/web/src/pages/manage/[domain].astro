---
import Base from "../../layouts/Base.astro";
import { API_BASE_URL, isValidDomain } from "@siteage/shared";
import type { ManageData } from "@siteage/shared";

const apiBase = import.meta.env.PUBLIC_API_URL || API_BASE_URL;
const { domain } = Astro.params;
const key = Astro.url.searchParams.get("key");

if (!domain || !isValidDomain(domain) || !key) {
  return Astro.redirect("/");
}

let data: ManageData | null = null;
let error: string | null = null;

try {
  const resp = await fetch(`${apiBase}/manage/${domain}?key=${key}`);
  if (resp.ok) {
    data = await resp.json() as ManageData;
  } else {
    const err = await resp.json().catch(() => null);
    error = (err as any)?.message || "Invalid or expired management link";
  }
} catch {
  error = "Unable to connect to the API";
}
---

<Base title={`Manage ${domain}`}>
  <div class="max-w-2xl mx-auto px-6 py-12 sm:py-20">
    <!-- Page header -->
    <div class="text-center mb-10">
      <span class="text-xs tracking-[0.3em] uppercase text-seal-dark font-medium">Domain Management</span>
      <h1 class="font-display text-2xl sm:text-3xl mt-3 text-ink">{domain}</h1>
      <div class="ornament-line max-w-32 mx-auto mt-4"></div>
    </div>

    {error && (
      <div class="card-base p-6 border-l-3 border-l-ink-muted/40">
        <p class="text-ink-muted font-light">{error}</p>
      </div>
    )}

    {data && (
      <div class="space-y-6">
        <!-- Status -->
        <div class="card-base p-6 sm:p-8">
          <h2 class="card-title">Status</h2>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-ink-muted font-light">Domain:</span>
              <span class="font-medium text-ink ml-2">{data.domain}</span>
            </div>
            <div>
              <span class="text-ink-muted font-light">Status:</span>
              <span class="font-medium text-ink ml-2">{data.status}</span>
            </div>
            <div>
              <span class="text-ink-muted font-light">Birth date:</span>
              <span class="font-medium text-ink ml-2">{data.verified_birth_at || data.birth_at || "Unknown"}</span>
            </div>
            <div>
              <span class="text-ink-muted font-light">Verification:</span>
              <span class="font-medium text-ink ml-2">{data.verification_status}</span>
            </div>
          </div>
        </div>

        <!-- Submit evidence -->
        <div class="card-base p-6 sm:p-8">
          <h2 class="card-title">Submit Earlier Birth Date Evidence</h2>
          <p class="text-sm text-ink-muted font-light mb-5">
            If you believe your site existed before the detected date, submit evidence for admin review.
          </p>
          <form id="evidence-form" class="space-y-5">
            <div>
              <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Evidence type</label>
              <select id="ev-type" class="select-archival">
                <option value="whois">WHOIS Record</option>
                <option value="git_history">Git History</option>
                <option value="dns_record">DNS Record</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Claimed birth date</label>
              <input type="datetime-local" id="ev-claimed" class="input-archival" required />
            </div>
            <div>
              <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Evidence URL (optional)</label>
              <input type="url" id="ev-url" class="input-archival" placeholder="https://..." />
            </div>
            <div>
              <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-2">Description</label>
              <textarea id="ev-desc" class="input-archival" rows="3" placeholder="Explain why you believe the earlier date..."></textarea>
            </div>
            <button type="submit" class="btn-primary">
              Submit Evidence
            </button>
          </form>
          <div id="ev-result" class="mt-4 hidden"></div>
        </div>

        <!-- Previous evidence -->
        {data.evidence && data.evidence.length > 0 && (
          <div class="card-base p-6 sm:p-8">
            <h2 class="card-title">Your Evidence Submissions</h2>
            <div class="space-y-3">
              {data.evidence.map((ev) => (
                <div class="flex items-center justify-between text-sm border-b border-divider pb-2">
                  <div>
                    <span class="font-medium text-ink">{ev.type}</span>
                    <span class="text-ink-muted/50 ml-2">claimed: {ev.claimed_at}</span>
                  </div>
                  <span class={`px-2 py-0.5 text-xs tracking-[0.1em] uppercase font-medium ${
                    ev.status === "approved" ? "text-seal-dark bg-seal-light/20" :
                    ev.status === "rejected" ? "text-ink-muted bg-parchment-dark" :
                    "text-azure bg-azure/10"
                  }`}>
                    {ev.status}
                  </span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </div>

  <script define:vars={{ domain, key }}>
    const API = import.meta.env.PUBLIC_API_URL || "https://api.siteage.org";

    document.getElementById("evidence-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const type = document.getElementById("ev-type").value;
      const claimed = document.getElementById("ev-claimed").value;
      const url = document.getElementById("ev-url").value;
      const description = document.getElementById("ev-desc").value;

      try {
        const resp = await fetch(`${API}/evidence/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            domain,
            key,
            type,
            claimed_at: new Date(claimed).toISOString(),
            url: url || undefined,
            description: description || undefined,
          }),
        });
        const data = await resp.json();
        const resultEl = document.getElementById("ev-result");
        resultEl.classList.remove("hidden");
        resultEl.innerHTML = resp.ok
          ? '<p class="text-seal-dark font-medium tracking-wide">Evidence submitted successfully! An admin will review it.</p>'
          : `<p class="text-ink-muted">${data.message || "Submission failed"}</p>`;
      } catch {
        alert("Failed to submit evidence");
      }
    });
  </script>
</Base>
