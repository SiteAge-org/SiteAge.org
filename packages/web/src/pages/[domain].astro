---
import Base from "../layouts/Base.astro";
import CertificateCard from "../components/CertificateCard.astro";
import TombstoneCard from "../components/TombstoneCard.astro";
import AgeDisplay from "../components/AgeDisplay.astro";
import RankingBar from "../components/RankingBar.astro";
import BadgePreview from "../components/BadgePreview.astro";
import Timeline from "../components/Timeline.astro";
import LookupLoading from "../components/LookupLoading.astro";
import ShareButtons from "../components/ShareButtons.astro";
import { API_BASE_URL, BADGE_BASE_URL, isValidDomain, formatAge } from "@siteage/shared";
import type { DomainDetail } from "@siteage/shared";

const apiBase = import.meta.env.PUBLIC_API_URL || API_BASE_URL;
const { domain } = Astro.params;

if (!domain || !isValidDomain(domain)) {
  return Astro.redirect("/");
}

let data: DomainDetail | null = null;
let needsLookup = false;
let error: string | null = null;

try {
  const resp = await fetch(`${apiBase}/${domain}`);

  if (resp.ok) {
    data = await resp.json() as DomainDetail;
  } else if (resp.status === 404) {
    needsLookup = true;
  } else {
    const err = await resp.json().catch(() => null);
    error = (err as any)?.message || "Failed to load domain data";
  }
} catch (e) {
  error = "Unable to connect to the API";
}

// Build dynamic OG meta data
const birth = data?.verified_birth_at || data?.birth_at;
const yearStr = birth ? new Date(birth).getUTCFullYear().toString() : null;
const ageStr = birth ? formatAge(birth) : null;
const badgeBase = import.meta.env.PUBLIC_BADGE_URL || BADGE_BASE_URL;

const ogTitle = birth
  ? `${domain} — Online Since ${yearStr}`
  : `${domain} — Age Certificate`;
const ogDesc = birth
  ? `${domain} has been online for ${ageStr}. Discover your website's age at SiteAge.org.`
  : `Look up the age of ${domain} at SiteAge.org.`;
const ogImage = `${badgeBase}/og/${domain}`;
---

<Base title={domain} ogTitle={ogTitle} ogDescription={ogDesc} ogImage={ogImage}>
  {needsLookup && (
    <LookupLoading domain={domain} apiBase={apiBase} />
  )}

  {!needsLookup && (
  <div class="max-w-4xl mx-auto px-6 py-10 sm:py-16">
    {error && (
      <div class="text-center py-16">
        <p class="text-ink-muted mb-6 font-light">{error}</p>
        <a href="/" class="text-sm text-azure hover:text-azure-light transition-colors tracking-wide">
          &larr; Return to search
        </a>
      </div>
    )}

    {data && (
      <div class="animate-fade-up">
        {data.status === "dead" ? (
          <TombstoneCard data={data} />
        ) : (
          <CertificateCard data={data} apiBase={apiBase} />
        )}
      </div>
    )}

    {data && (
      <div class="mt-10 space-y-6">
        <div class="animate-fade-up delay-100">
          <AgeDisplay data={data} />
        </div>

        {data.rank_percentile !== null && (
          <div class="animate-fade-up delay-200">
            <RankingBar percentile={data.rank_percentile} />
          </div>
        )}

        <div class="animate-fade-up delay-300">
          <ShareButtons domain={data.domain} birthAt={data.verified_birth_at || data.birth_at} deathAt={data.death_at} isDead={data.status === "dead"} />
        </div>

        <div class="animate-fade-up delay-400">
          <BadgePreview domain={data.domain} isVerified={data.verification_status === "verified"} />
        </div>

        <div class="animate-fade-up delay-500">
          <Timeline domain={data.domain} firstSnapshotUrl={data.first_snapshot_url} birthAt={data.verified_birth_at || data.birth_at} />
        </div>

        <!-- Claim / Manage section -->
        <div class="animate-fade-up delay-600 text-center pt-6">
          <div class="ornament-line max-w-64 mx-auto mb-6"></div>
          {data.verification_status === "verified" ? (
            <Fragment>
              <p class="text-ink-muted mb-4 font-light">This website has a verified owner. Use the Magic Link sent to your email to manage this domain.</p>
              <p class="text-sm mt-3 font-light">
                <a
                  href={`/resend/${data.domain}`}
                  class="text-azure hover:text-azure-light transition-colors tracking-wide font-medium"
                >
                  Resend Magic Link
                </a>
                <span class="text-divider mx-2">|</span>
                <a
                  href={`/verify/${data.domain}`}
                  class="text-azure hover:text-azure-light transition-colors tracking-wide font-medium"
                >
                  Re-verify ownership
                </a>
              </p>
            </Fragment>
          ) : (
            <Fragment>
              <p class="text-ink-muted mb-4 font-light">Own this website?</p>
              <a
                href={`/verify/${data.domain}`}
                class="inline-flex items-center gap-2 px-8 py-3 bg-seal text-ink font-medium tracking-wider uppercase text-sm hover:bg-seal-light transition-colors duration-200"
              >
                Claim & Verify
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25"/>
                </svg>
              </a>
            </Fragment>
          )}
        </div>

        <!-- Growth CTA -->
        <div class="animate-fade-up delay-600 text-center pt-8">
          <p class="text-ink-muted font-light mb-4">Curious about your own website?</p>
          <a href="/" class="btn-primary">Look Up Your Website</a>
        </div>
      </div>
    )}
  </div>
  )}
</Base>
