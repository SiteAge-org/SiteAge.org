---
import Base from "../../layouts/Base.astro";
import { API_BASE_URL, isValidDomain } from "@siteage/shared";

const { domain } = Astro.params;
const apiBase = import.meta.env.PUBLIC_API_URL || API_BASE_URL;

if (!domain || !isValidDomain(domain)) {
  return Astro.redirect("/");
}
---

<Base title={`Verify ${domain}`}>
  <div class="max-w-2xl mx-auto px-6 py-12 sm:py-20">
    <!-- Page header -->
    <div class="text-center mb-10">
      <span class="text-xs tracking-[0.3em] uppercase text-seal-dark font-medium">Ownership Verification</span>
      <h1 class="font-display text-2xl sm:text-3xl mt-3 text-ink">{domain}</h1>
      <div class="ornament-line max-w-32 mx-auto mt-4"></div>
    </div>

    <div class="card-base p-8 sm:p-10 relative decorative-frame noise-overlay overflow-hidden">
      <div class="relative">
        <!-- Step 1: Email -->
        <div id="step-email">
          <h2 class="card-title">Step 1: Enter your email</h2>
          <div class="space-y-5">
            <input
              type="email"
              id="verify-email"
              placeholder="you@example.com"
              class="input-archival"
            />
            <div>
              <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted font-medium block mb-3">Verification method</label>
              <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="method" value="dns_txt" checked class="accent-seal" />
                  <span class="text-sm text-ink">DNS TXT Record</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="method" value="meta_tag" class="accent-seal" />
                  <span class="text-sm text-ink">HTML Meta Tag</span>
                </label>
              </div>
            </div>
            <button
              id="btn-init"
              class="btn-primary"
            >
              Start Verification
            </button>
          </div>
        </div>

        <!-- Step 2: Instructions (hidden by default) -->
        <div id="step-instructions" class="hidden">
          <h2 class="card-title">Step 2: Add verification record</h2>
          <div id="instructions-content" class="bg-parchment-dark/60 p-4 text-sm text-ink-muted font-mono mb-4"></div>
          <p class="text-sm text-ink-muted font-light mb-5">After adding the record, click verify below.</p>
          <button
            id="btn-verify"
            class="btn-seal"
          >
            Verify Now
          </button>
        </div>

        <!-- Result -->
        <div id="step-result" class="hidden">
          <div id="result-content"></div>
        </div>

        <!-- Resend section for already-verified domains -->
        <div class="mt-8 pt-6">
          <div class="ornament-line mb-6"></div>
          <p class="text-sm text-ink-muted font-light mb-2">Already verified? Lost your management link?</p>
          <button
            id="btn-resend"
            class="text-sm text-azure hover:text-azure-light transition-colors tracking-wide font-medium"
          >
            Resend Magic Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ domain, apiBase }}>
    const API = apiBase;
    let token = "";

    document.getElementById("btn-init")?.addEventListener("click", async () => {
      const email = document.getElementById("verify-email").value;
      const method = document.querySelector('input[name="method"]:checked')?.value;
      if (!email) return alert("Please enter your email");

      try {
        const resp = await fetch(`${API}/verify/init`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ domain, email, method }),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.message);

        token = data.token;
        document.getElementById("instructions-content").textContent = data.instructions;
        document.getElementById("step-email").classList.add("hidden");
        document.getElementById("step-instructions").classList.remove("hidden");
      } catch (e) {
        alert(e.message || "Failed to initialize verification");
      }
    });

    document.getElementById("btn-verify")?.addEventListener("click", async () => {
      try {
        const resp = await fetch(`${API}/verify/check`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ domain, token }),
        });
        const data = await resp.json();
        document.getElementById("step-instructions").classList.add("hidden");
        document.getElementById("step-result").classList.remove("hidden");
        document.getElementById("result-content").innerHTML = data.verified
          ? '<p class="text-seal-dark font-medium tracking-wide">Verification successful! Check your email for the management link.</p>'
          : `<p class="text-ink-muted">Verification failed: ${data.message}</p>`;
      } catch (e) {
        alert("Verification check failed");
      }
    });

    document.getElementById("btn-resend")?.addEventListener("click", async () => {
      const email = document.getElementById("verify-email").value;
      if (!email) return alert("Please enter your email first");

      try {
        const resp = await fetch(`${API}/verify/resend`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ domain, email }),
        });
        const data = await resp.json();
        alert(resp.ok ? "Magic Link sent to your email!" : data.message);
      } catch (e) {
        alert("Failed to resend");
      }
    });
  </script>
</Base>
