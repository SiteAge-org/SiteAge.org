---
import { WEB_BASE_URL, BADGE_BASE_URL, birthYear, ageYears } from "@siteage/shared";

interface Props {
  domain: string;
  birthAt?: string | null;
  deathAt?: string | null;
  isDead?: boolean;
}

const { domain, birthAt, deathAt, isDead = false } = Astro.props;
const pageUrl = `${WEB_BASE_URL}/${domain}`;
const badgeBase = import.meta.env.PUBLIC_BADGE_URL || BADGE_BASE_URL;
const ogUrl = `${badgeBase}/og/${domain}`;
const year = birthAt ? birthYear(birthAt) : null;
const deathYear = deathAt ? birthYear(deathAt) : null;
const years = birthAt ? ageYears(birthAt, deathAt || undefined) : 0;

let shareText: string;
if (isDead && year) {
  shareText = `${domain} went offline after ${years} year${years !== 1 ? "s" : ""} on the web (${year}–${deathYear || "?"}).\n\nHow old is YOUR website?`;
} else if (year && years >= 10) {
  shareText = `${domain} has been online since ${year} — ${years} years and counting.\n\nHow old is your website?`;
} else if (year) {
  shareText = `${domain} first appeared online in ${year}.\n\nEvery website has a story. What's yours?`;
} else {
  shareText = `How old is your website? Find out instantly:`;
}
---

<div class="card-base p-6 sm:p-8" id="share-section">
  <h2 class="card-title">Share</h2>

  <div class="flex flex-wrap gap-3">
    <!-- X (Twitter) -->
    <button
      class="share-btn"
      data-channel="twitter"
      data-url={`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`}
      aria-label="Share on X"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>
      <span>Post</span>
    </button>

    <!-- LinkedIn -->
    <button
      class="share-btn"
      data-channel="linkedin"
      data-url={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`}
      aria-label="Share on LinkedIn"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
      </svg>
      <span>LinkedIn</span>
    </button>

    <!-- Facebook -->
    <button
      class="share-btn"
      data-channel="facebook"
      data-url={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`}
      aria-label="Share on Facebook"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
      </svg>
      <span>Facebook</span>
    </button>

    <!-- Copy Link -->
    <button
      class="share-btn"
      data-channel="copy"
      data-copy-url={pageUrl}
      aria-label="Copy link"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
      </svg>
      <span class="copy-label">Copy Link</span>
    </button>

    <!-- Download Certificate -->
    <button
      class="share-btn"
      data-channel="download"
      data-og-fallback={ogUrl}
      data-domain={domain}
      data-dead={isDead ? "true" : undefined}
      aria-label="Download certificate image"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
      </svg>
      <span class="download-label">Download</span>
    </button>
  </div>
</div>

<style>
  .share-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border: 1px solid var(--color-divider);
    color: var(--color-ink-muted);
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .share-btn:hover {
    border-color: var(--color-seal);
    color: var(--color-seal-dark);
  }
</style>

<script>
  const section = document.getElementById("share-section")!;

  section.querySelectorAll<HTMLButtonElement>(".share-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const channel = btn.dataset.channel;

      if (channel === "copy") {
        const url = btn.dataset.copyUrl || "";
        navigator.clipboard.writeText(url).then(() => {
          const label = btn.querySelector<HTMLSpanElement>(".copy-label");
          if (label) {
            label.textContent = "Copied!";
            setTimeout(() => { label.textContent = "Copy Link"; }, 2000);
          }
        });
        return;
      }

      if (channel === "download") {
        const domain = btn.dataset.domain;
        const ogFallback = btn.dataset.ogFallback;
        if (!domain) return;
        const label = btn.querySelector<HTMLSpanElement>(".download-label");
        if (label) label.textContent = "Generating\u2026";
        try {
          const isDead = btn.dataset.dead === "true";
          const sourceEl = document.getElementById(isDead ? "tombstone" : "certificate");
          if (!sourceEl) throw new Error("Card element not found");
          const { downloadCertificate } = await import("../scripts/certificate-download");
          await downloadCertificate(sourceEl, domain);
        } catch {
          // Fallback to server-side OG endpoint
          if (ogFallback) {
            try {
              const resp = await fetch(ogFallback);
              const blob = await resp.blob();
              const blobUrl = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = blobUrl;
              a.download = `siteage-${domain}.png`;
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(blobUrl);
            } catch {
              // Silently fail
            }
          }
        }
        if (label) label.textContent = "Download";
        return;
      }

      const url = btn.dataset.url;
      if (url) {
        window.open(url, "_blank", "width=550,height=420,noopener,noreferrer");
      }
    });
  });
</script>
