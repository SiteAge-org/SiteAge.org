---
import { BADGE_BASE_URL, WEB_BASE_URL } from "@siteage/shared";

interface Props {
  domain: string;
  isVerified: boolean;
}

const { domain, isVerified } = Astro.props;
const badgeUrl = `${BADGE_BASE_URL}/${domain}`;
const linkUrl = `${WEB_BASE_URL}/${domain}`;

const defaultType = isVerified ? "established" : "since";
const defaultFormat = "year";
---

<div class="card-base p-6 sm:p-8" id="badge-customizer" data-badge-url={badgeUrl} data-link-url={linkUrl} data-default-type={defaultType} data-default-format={defaultFormat}>
  <h2 class="card-title">Badge</h2>

  <!-- Selectors -->
  <div class="space-y-4 mb-6">
    <!-- Style selector -->
    <div>
      <p class="text-[10px] tracking-[0.15em] uppercase text-ink-muted/50 font-medium mb-2">Style</p>
      <div class="flex flex-wrap gap-2">
        <button class="badge-chip active" data-group="style" data-value="flat">Flat</button>
        <button class="badge-chip" data-group="style" data-value="flat-square">Flat Square</button>
        <button class="badge-chip" data-group="style" data-value="for-the-badge">For the Badge</button>
      </div>
    </div>

    <!-- Message type selector -->
    <div>
      <p class="text-[10px] tracking-[0.15em] uppercase text-ink-muted/50 font-medium mb-2">Message</p>
      <div class="flex flex-wrap items-center gap-2">
        <button class={`badge-chip ${defaultType === "since" ? "active" : ""}`} data-group="type" data-value="since">Since</button>
        {isVerified ? (
          <button class={`badge-chip badge-chip--verified ${defaultType === "established" ? "active" : ""}`} data-group="type" data-value="established">Established</button>
        ) : (
          <span class="text-[10px] text-ink-muted/40 italic ml-1">Verify ownership to unlock more options</span>
        )}
      </div>
    </div>

    <!-- Format selector -->
    <div>
      <p class="text-[10px] tracking-[0.15em] uppercase text-ink-muted/50 font-medium mb-2">Format</p>
      <div class="flex flex-wrap items-center gap-2">
        <button class="badge-chip active" data-group="format" data-value="year">Year</button>
        {isVerified ? (
          <>
            <button class="badge-chip badge-chip--verified" data-group="format" data-value="month">Month</button>
            <button class="badge-chip badge-chip--verified" data-group="format" data-value="date">Date</button>
            <button class="badge-chip badge-chip--verified" data-group="format" data-value="age">Age</button>
            <button class="badge-chip badge-chip--verified" data-group="format" data-value="days">Days</button>
          </>
        ) : (
          <span class="text-[10px] text-ink-muted/40 italic ml-1">Verify ownership to unlock more options</span>
        )}
      </div>
    </div>
  </div>

  <!-- Live Preview -->
  <div class="bg-parchment/60 p-4 rounded-sm mb-8 text-center">
    <img id="badge-preview" src={`${badgeUrl}?style=flat&type=${defaultType}&format=${defaultFormat}`} alt="SiteAge badge" class="inline-block h-5" data-ftb-class="h-7" data-default-class="h-5" />
  </div>

  <!-- Embed codes -->
  <div class="space-y-4">
    <div>
      <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted/50 font-medium block mb-2">HTML</label>
      <div class="relative">
        <code class="block bg-parchment-dark rounded px-4 py-3 text-xs text-ink-muted font-mono overflow-x-auto" id="html-code"></code>
        <button data-copy="html-code" class="copy-btn absolute top-2 right-2 text-[10px] tracking-[0.1em] uppercase px-2 py-1 bg-white border border-divider text-ink-muted hover:text-seal-dark hover:border-seal/30 transition-colors">Copy</button>
      </div>
    </div>
    <div>
      <label class="text-[10px] tracking-[0.15em] uppercase text-ink-muted/50 font-medium block mb-2">Markdown</label>
      <div class="relative">
        <code class="block bg-parchment-dark rounded px-4 py-3 text-xs text-ink-muted font-mono overflow-x-auto" id="md-code"></code>
        <button data-copy="md-code" class="copy-btn absolute top-2 right-2 text-[10px] tracking-[0.1em] uppercase px-2 py-1 bg-white border border-divider text-ink-muted hover:text-seal-dark hover:border-seal/30 transition-colors">Copy</button>
      </div>
    </div>
  </div>
</div>

<style>
  .badge-chip {
    padding: 0.25rem 0.625rem;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border: 1px solid var(--color-divider);
    color: var(--color-ink-muted);
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .badge-chip:hover {
    border-color: var(--color-azure);
    color: var(--color-azure);
  }
  .badge-chip.active {
    border-color: var(--color-azure);
    color: var(--color-azure);
    background-color: color-mix(in srgb, var(--color-azure) 8%, transparent);
  }
  .badge-chip--verified {
    border-style: dashed;
    border-color: color-mix(in srgb, var(--color-seal) 40%, var(--color-divider));
  }
  .badge-chip--verified:hover {
    border-color: var(--color-seal);
    color: var(--color-seal-dark);
    border-style: solid;
  }
  .badge-chip--verified.active {
    border-color: var(--color-seal);
    color: var(--color-seal-dark);
    background-color: color-mix(in srgb, var(--color-seal) 10%, transparent);
    border-style: solid;
  }
</style>

<script>
  const root = document.getElementById("badge-customizer")!;
  const badgeUrl = root.dataset.badgeUrl!;
  const linkUrl = root.dataset.linkUrl!;
  const defaultType = root.dataset.defaultType!;
  const defaultFormat = root.dataset.defaultFormat!;

  const state: Record<string, string> = {
    style: "flat",
    type: defaultType,
    format: defaultFormat,
  };

  function buildBadgeSrc(): string {
    const params = new URLSearchParams();
    if (state.style !== "flat") params.set("style", state.style);
    if (state.type !== "since") params.set("type", state.type);
    if (state.format !== "year") params.set("format", state.format);
    const qs = params.toString();
    return qs ? `${badgeUrl}?${qs}` : badgeUrl;
  }

  function updatePreview(): void {
    const src = buildBadgeSrc();
    const img = document.getElementById("badge-preview") as HTMLImageElement;
    img.src = src;

    // Adjust height for "for-the-badge" style
    if (state.style === "for-the-badge") {
      img.className = "inline-block " + img.dataset.ftbClass;
    } else {
      img.className = "inline-block " + img.dataset.defaultClass;
    }

    // Build embed URLs (always include params in embed for clarity)
    const embedParams = new URLSearchParams();
    if (state.style !== "flat") embedParams.set("style", state.style);
    if (state.type !== "since") embedParams.set("type", state.type);
    if (state.format !== "year") embedParams.set("format", state.format);
    const embedQs = embedParams.toString();
    const embedUrl = embedQs ? `${badgeUrl}?${embedQs}` : badgeUrl;

    document.getElementById("html-code")!.textContent =
      `<a href="${linkUrl}"><img src="${embedUrl}" alt="SiteAge badge"></a>`;
    document.getElementById("md-code")!.textContent =
      `[![SiteAge](${embedUrl})](${linkUrl})`;
  }

  // Initial render
  updatePreview();

  // Chip click handlers
  root.querySelectorAll<HTMLButtonElement>(".badge-chip").forEach((chip) => {
    chip.addEventListener("click", () => {
      const group = chip.dataset.group!;
      const value = chip.dataset.value!;

      // Deactivate siblings
      root.querySelectorAll<HTMLButtonElement>(`.badge-chip[data-group="${group}"]`).forEach(
        (c) => c.classList.remove("active"),
      );
      chip.classList.add("active");

      state[group] = value;
      updatePreview();
    });
  });

  // Copy buttons
  root.querySelectorAll<HTMLButtonElement>(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-copy");
      if (!targetId) return;
      const el = document.getElementById(targetId);
      if (!el) return;
      navigator.clipboard.writeText(el.textContent || "").then(() => {
        btn.textContent = "Copied!";
        setTimeout(() => { btn.textContent = "Copy"; }, 2000);
      });
    });
  });
</script>
