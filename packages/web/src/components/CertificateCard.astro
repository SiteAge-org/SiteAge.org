---
import { formatAge, birthYear, BADGE_BASE_URL } from "@siteage/shared";
import type { DomainDetail } from "@siteage/shared";

interface Props {
  data: DomainDetail;
  apiBase: string;
}

const { data, apiBase } = Astro.props;
const badgeBase = import.meta.env.PUBLIC_BADGE_URL || BADGE_BASE_URL;
const birth = data.verified_birth_at || data.birth_at;
const isVerified = data.verification_status === "verified";
const catalogedDate = new Date(data.created_at).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric", timeZone: "UTC" });
---

<div id="certificate" class="relative bg-gradient-to-b from-white to-parchment/80 border border-divider p-10 sm:p-14 max-w-2xl mx-auto overflow-hidden noise-overlay shadow-[var(--shadow-certificate)]">
  <!-- Double-layer corner ornaments -->
  <div class="absolute top-3 left-3 w-12 h-12 border-t-2 border-l-2 border-seal/30"></div>
  <div class="absolute top-5 left-5 w-4 h-4 border-t border-l border-seal/15"></div>
  <div class="absolute top-3 right-3 w-12 h-12 border-t-2 border-r-2 border-seal/30"></div>
  <div class="absolute top-5 right-5 w-4 h-4 border-t border-r border-seal/15"></div>
  <div class="absolute bottom-3 left-3 w-12 h-12 border-b-2 border-l-2 border-seal/30"></div>
  <div class="absolute bottom-5 left-5 w-4 h-4 border-b border-l border-seal/15"></div>
  <div class="absolute bottom-3 right-3 w-12 h-12 border-b-2 border-r-2 border-seal/30"></div>
  <div class="absolute bottom-5 right-5 w-4 h-4 border-b border-r border-seal/15"></div>

  <!-- Inner decorative border -->
  <div class="absolute inset-6 border border-divider/50 pointer-events-none"></div>

  <div class="relative text-center">
    <!-- Header -->
    <div class="mb-8">
      <p class="text-[10px] tracking-[0.4em] uppercase text-seal-dark font-medium mb-2">Certificate of Website Longevity</p>
      <div class="ornament-line max-w-48 mx-auto"></div>
    </div>

    <!-- Domain -->
    <h1 class="font-display text-3xl sm:text-4xl mb-3 text-ink">{data.domain}</h1>

    <!-- Verification seal -->
    {isVerified && (
      <div class="inline-flex items-center gap-1.5 px-3 py-1 bg-gradient-to-r from-seal-light/20 to-seal/10 border border-seal/30 text-seal-dark text-xs tracking-[0.15em] uppercase font-medium mb-4">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        Verified Owner
      </div>
    )}

    <!-- Birth date -->
    {birth ? (
      <div class="my-8">
        <p class="text-xs tracking-[0.2em] uppercase text-ink-muted mb-2">{isVerified ? "Established" : "Online Since"}</p>
        <div class="relative inline-block">
          <!-- Blurred gold glow behind year -->
          <span class="absolute inset-0 bg-seal/[0.06] blur-xl rounded-full scale-150 pointer-events-none"></span>
          <p class="relative font-display text-6xl sm:text-7xl text-ink leading-none">{birthYear(birth)}</p>
        </div>
        <p class="text-sm text-ink-muted mt-3 font-light">{new Date(birth).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })}</p>
      </div>
    ) : (
      <div class="my-8">
        <p class="font-display text-3xl text-ink-muted">Birth Date Unknown</p>
        <p class="text-sm text-ink-muted/70 mt-3 font-light">The archives could not be reached. Try again later.</p>
        <button
          id="recheck-btn"
          type="button"
          class="btn-primary mt-4 text-sm"
          data-domain={data.domain}
          data-api-base={apiBase}
        >
          Re-check Archives
        </button>
      </div>
    )}

    <!-- Age -->
    {birth && (
      <div class="mb-8">
        <div class="ornament-line max-w-32 mx-auto mb-4"></div>
        <p class="text-ink-muted">
          Age: <span class="font-medium text-ink">{formatAge(birth)}</span>
        </p>
      </div>
    )}

    <!-- Download certificate -->
    <div class="mt-4 mb-2">
      <button
        id="download-cert-btn"
        type="button"
        class="inline-flex items-center gap-1.5 text-xs tracking-[0.1em] uppercase text-seal-dark hover:text-seal transition-colors cursor-pointer"
        data-og-url={`${badgeBase}/og/${data.domain}`}
        data-domain={data.domain}
      >
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
        </svg>
        Download Certificate
      </button>
    </div>

    <!-- Footer -->
    <div class="pt-6">
      <div class="ornament-line mb-4"></div>
      <p class="text-[10px] text-ink-muted/70 tracking-[0.15em] uppercase mb-2">Cataloged on {catalogedDate}</p>
      <p class="text-[10px] text-ink-muted/50 tracking-[0.15em] uppercase">Certified by SiteAge.org &middot; Data from Internet Archive</p>
    </div>
  </div>
</div>

<script>
  // Download certificate handler
  const dlBtn = document.getElementById("download-cert-btn");
  if (dlBtn) {
    dlBtn.addEventListener("click", async () => {
      const ogUrl = dlBtn.getAttribute("data-og-url");
      const domain = dlBtn.getAttribute("data-domain");
      if (!ogUrl) return;

      dlBtn.textContent = "Downloading\u2026";
      try {
        const resp = await fetch(ogUrl);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `siteage-${domain}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {
        // Silently fail
      }
      dlBtn.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg> Download Certificate`;
    });
  }

  const btn = document.getElementById("recheck-btn");
  if (btn) {
    btn.addEventListener("click", async () => {
      const domain = btn.getAttribute("data-domain");
      const apiBase = btn.getAttribute("data-api-base");
      btn.textContent = "Checking\u2026";
      btn.setAttribute("disabled", "true");

      try {
        const resp = await fetch(`${apiBase}/lookup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: domain, force: true }),
        });

        if (resp.status === 429) {
          btn.textContent = "Please wait before retrying";
          setTimeout(() => {
            btn.textContent = "Re-check Archives";
            btn.removeAttribute("disabled");
          }, 5000);
          return;
        }

        if (resp.ok) {
          location.reload();
        } else {
          btn.textContent = "Check failed — try again later";
          setTimeout(() => {
            btn.textContent = "Re-check Archives";
            btn.removeAttribute("disabled");
          }, 3000);
        }
      } catch {
        btn.textContent = "Network error — try again";
        setTimeout(() => {
          btn.textContent = "Re-check Archives";
          btn.removeAttribute("disabled");
        }, 3000);
      }
    });
  }
</script>
